<!DOCTYPE html>
<html>
<head>
    <title>Login - MakerWorld Print</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="card">
        <h2>ðŸ‘¤ Login or Sign Up</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="auth()">Enter Dashboard</button>
        <p id="msg" style="font-size: 12px; color: #666;"></p>
    </div>

    <script>
        const BIN_ID = '{{ bin_id }}'; 
        const API_KEY = '{{ api_key }}';

        async function auth() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            if(!user || !pass) return alert("Fill everything out!");

            document.getElementById('msg').innerText = "Checking bin...";
            
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } });
            const data = await res.json();
            let record = data.record;

            // Initialize bins if they don't exist
            if(!record.users) record.users = {};
            if(!record.orders) record.orders = [];

            if(record.users[user]) {
                if(record.users[user] === pass) {
                    login(user);
                } else {
                    alert("Wrong password!");
                }
            } else {
                // New User Creation
                record.users[user] = pass;
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify(record)
                });
                login(user);
            }
        }

        function login(user) {
            localStorage.setItem('currentUser', user);
            window.location.href = "/dashboard";
        }
    </script>
</body>
</html>